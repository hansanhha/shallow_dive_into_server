[도커 컨테이너의 가상 파일 시스템](#도커-컨테이너의-가상-파일-시스템)

[이미지 레이어와 쓰기 가능 레이어](#이미지-레이어와-쓰기-가능-레이어)

[쓰기 가능 레이어의 치명적인 단점](#쓰기-가능-레이어의-치명적인-단점)

[도커 볼륨](#도커-볼륨)

[마운트](#마운트)

[파일 시스템(상세)](#파일-시스템-상세)

## 도커 컨테이너의 가상 파일 시스템

도커 컨테이너의 디스크는 도커가 이미지 레이어와 컨테이너의 쓰기 가능 레이어로 구성된 레이어를 합친 뒤 전달한 가상 파일 시스템으로

단일 디스크이며, 컨테이너 간 독립된 파일 시스템을 가짐

즉, 동일한 이미지에서 실행해도 여러 컨테이너는 각자만의 파일 시스템을 가짐

리눅스 컨테이너: `/dev/sda1`

윈도우: `C:\`

## 이미지 레이어와 쓰기 가능 레이어

이미지 레이어와 쓰기 가능 레이어의 특성이 다름

이미지 레이어
- 모든 컨테이너가 공유할 수 있음
- 읽기 전용
- 이미지를 내려받으면, 삭제할 때까지 호스트 컴퓨터의 이미지 레이어에 존재함

쓰기 가능 레이어
- 이미지 레이어와 달리, 컨테이너 간 공유하지 않고 독립된 레이어를 가짐
- 컨테이너와 같은 생애주기를 가짐 - 컨테이너가 실행될 때 생성되며, 삭제될 떄 함께 삭제됨(종료했을 때는 유지)
- 컨테이너 내의 파일 시스템 변경 사항(파일 생성, 수정, 삭제 등)을 저장함

### 기록 중 복사 (copy-on-write)

도커는 기록 중 복사라는 방법을 사용해 읽기 전용 레이어의 파일을 수정할 수 있음

컨테이너에서 이미지 레이어에 포함된 파일을 수정하려 하면, 도커가 이 파일을 쓰기 가능 레이어로 복사해 온 다음 쓰기 가능 레이어에서 파일 수정함

따라서 다른 컨테이너나 이미지에 영향을 주지 않고 파일을 수정할 수 있게 됨 (수정된 파일은 해당 컨테이너의 쓰기 가능 레이어에만 존재하기 때문)

## 쓰기 가능 레이어의 치명적인 단점

쓰기 가능 레이어는 컨테이너가 실행되는 동안 발생한 파일 변경 사항을 저장하지만, 컨테이너와 생애주기를 같이 하기 때문에

컨테이너를 삭제하면 수정된 데이터 모두 손실됨

일시적 데이터를 캐싱만 하는 경우라면 상관없지만 데이터베이스를 컨테이너로 실행했을 때, 한 번이라도 컨테이너가 꺼지면 그동안의 DB 데이터가 모조리 날라감

도커는 퍼시스턴스 데이터를 다루기 위해 도커 볼륨과 마운트라는 요소를 지원함

## 도커 볼륨

도커 볼륨은 아래와 같은 특성을 가짐
- 도커 볼륨은 도커에서 스토리지 다루는 단위임
- 컨테이너와 별도의 생애주기를 가지며 독립적으로 존재함
- 컨테이너에 연결할 수 있음

**퍼시스턴스 유상태 애플리케이션을 컨테이너로 실행하려면 도커 볼륨이 필요함**

### 볼륨 사용 방법

1. 볼륨 생성
2. 애플리케이션 컨테이너 연결
    - 파일 시스템의 한 디렉토리가 됨
    - 새로운 컨테이너에 다시 볼륨을 연결해도 데이터가 그대로 유지됨

#### 수동

수동으로 직접 볼륨을 생성해 컨테이너에 연결하는 방법

`--volume` 플래그는 이미지에 VOLUME 명령어로 볼륨이 정의되어 있어도, 플래그에 지정된 볼륨을 컨테이너에 마운트함

도커 파일의 VOLUME 명령어가 무시되어 새로운 볼륨을 생성하지 않음

```text
# 볼륨 생성
docker volume create <volume_name>

# 컨테이너 실행 및 볼륨 연결 
docker container run -v <volume_name>:<target_directory> <image>

docker volume create simple-volume

docker container run -d -p 8080:8080 -v simple-volume:/data --name simple-java-project hansanhha/simple-java-project
```

#### Dockerfile

도커 스크립트에서 VOLUME 명령어를 사용하는 방법

이 명령어를 사용해 만든 이미지로 컨테이너를 실행하면 자동으로 항상 새로운 볼륨을 생성해 컨테이너에 연결해줌

```dockerfile
# ... iustruction

# VOLUMNE <target-directory>
VOLUME /data
```

위의 이미지를 실행하면 컨테이너에 /data 디렉토리가 생성됨(윈도우는 C:\data)

다른 디렉토리와 똑같이 사용할 수 있지만, 이 디렉토리의 내용은 볼륨에 영구적으로 저장됨

컨테이너를 실행할 때마다 새로운 볼륨을 생성해서 연결하기 때문에 기존의 컨테이너에 연결된 볼륨을 그대로 사용하려면 옵션을 추가해야 됨

다만 디렉토리를 동시에 접근하게 허용하면 애플리케이션이 비정상적으로 동작할 수도 있으며, 이미지에서 정의하는 것보다 명시적으로 관리하는 편이 더 나음

```text
# 컨테이너 실행 시 다른 컨테이너의 볼륨 연결
docker container run --name <container_name> --volumes-from <other container_name> <image>

docker container run --name simple-java-project2 --volumes-from simple-java-project hansanhha/simple-java-project
```

## 마운트

마운트 또는 바인드 마운드는 호스트 컴퓨터 파일 시스템의 디렉토리를 컨테이너 파일 시스템의 디렉토리로 만듦

바인드 마운트도 볼륨과 마찬가지로 컨테이너의 입장에서는 하나의 디렉토리에 불과하지만,

컨테이너가 호스트 컴퓨터의 파일에 직접 접근할 수 있고 그 반대도 가능해짐

호스트 컴퓨터에서 접근 가능한 파일 시스템이라면 무엇이든 컨테이너에서도 사용할 수 있음
- SSD 디스크
- 네트워크 상에서 사용하는 분산 스토리지
- RAID가 적용된 디스크 어레이를 가진 서버 등

컨테이너는 호스트 컴퓨터에 대한 공격을 방지하기 위해 최소 권한을 가진 계정으로 실행되는데, 바인드 마운트를 사용하면 호스트 컴퓨터 파일에 접근하기 위해 권한 상승이 필요해짐

그래서 도커 스크립트에서 USER 명령어를 사용해 컨테이너에 관리자 권한을 부여함(리눅스-root, 윈도우-ContainerAdministrator)

```text
# 컨테이너 마운트 실행
docker container run --mount type=bind,source=<mount_directory or file>,target=<target_directory> <image_name>
```

#### 읽기 전용 마운트

바인드 마운트는 기본적으로 양방향으로 동작함

만약 컨테이너에서 파일 쓰기 작업을 할 필요가 없다면 호스트 컴퓨터의 디렉토리를 읽기 전용으로 컨테이너에 연결할 수 있음

호스트 컴퓨터에 작성한 설정을 컨테이너에 적용하기 위해 자주 쓰이는 방법으로, 이미지를 수정하지 않고도 애플리케이션의 설정을 변경할 수 있음

```text
# 컨테이너 읽기 전용 마운트 실행
docker container run --mount type=bind,source=<mount_directory or file>,target=<target_directory>,readonly <image_name>
```

### 파일 시스템 마운트의 한계점

#### 파일 충돌

컨테이너가 마운트할 대상 디렉토리에 포함된 파일과 이미지 레이어에 명시된 파일명이 같은 경우

컨테이너가 해당 디렉토리에 마운트한다면 이미지 레이어에 명시된 파일이 덮어씌워져서 이미지에 포함된 원래 파일은 사용할 수 없음

#### 단일 파일 마운트에 대한 리눅스와 윈도우 컨테이너의 동작 방식 차이

컨테이너에 이미 존재하는 디렉토리에 호스트의 파일 하나를 마운트하는 경우

리눅스 컨테이너는 기존 디렉토리에 하나의 파일이 정상적으로 마운트되는 반면, 윈도우 컨테이너는 에러를 발생시킴

```text
// 윈도우에서 실행하면 에러 발생
PS C:\Users\kwixs\Code\backend\cloud native\container> docker container run --mount type=bind,source="$(pwd)/new/123.txt",target=C:\init\123.txt diamol/ch06-bind-mount
docker: Error response from daemon: invalid mount config for type "bind": invalid mount path: 'C:/init/123.txt' mount path must be absolute.
See 'docker run --help'.
```

#### 분산 파일 시스템에서 지원하지 않는 기능이 있는 경우

분산 파일 시스템을 컨테이너에 바인드 마운트한 경우

네트워크상의 모든 컴퓨터에서 데이터에 접근할 수 있지만, 분산 파일 시스템의 메커니즘은 로컬 컴퓨터 운영체제의 파일 시스템과 다른 경우가 많음 (AWS S3 등)

그래서 일반적인 파일 시스템 기능 중에서 지원하지 않는 기능이 있을 수 있음

컨테이너에 분산 스토리지를 마운트할 계획이라면, 바인드 마운트의 원본 스토리지가 컨테이너에서 사용하는 모든 파일 시스템 기능을 제공하지 않을 수 있기 때문에 로컬 스토리지와 차이가 있다는 것을 고려해야 됨

## 파일 시스템 (상세)

모든 컨테이너는 도커가 다양한 출처(이미지 레이어, 쓰기 가능 레이어 등)로부터 모아 만든 단일 가상 디스크로 구성된 파일 시스템을 가짐

이 파일 시스템을 **유니온 파일 시스템(Union File System)**이라고 함

유니온 파일 시스템은 호스트 컴퓨터의 운영체제마다 다른 방식으로 구현되어 있음

컨테이너는 유니온 파일 시스템을 통해 물리적 위치가 서로 다른 파일과 디렉토리(하나 이상의 볼륨 마운트와 바인드 마운트 등)를 단일 디스크를 사용하듯 접근할 수 있음

```text
-----------Container---------
|                           |
| -----------------------   |
| |   Writeable layer   |   | <--- 모든 컨테이너에는 쓰기 가능 레이어가 있음
| -----------------------   |       쓰기 가능 레이어는 컨테이너와 같은 생애주기를 가짐 
|                           |       컨테이너가 삭제되면 쓰기 가능 레이어에 저장된 데이터도 함께 유실됨
| -----------------------   |
| |   Bind mount: local |   | <--- 바인드 마운트는 호스트 컴퓨터 스토리지의 특정 경로를 컨테이너의 대상 디렉토리로 연결함
| -----------------------   |   |  원본 스토리지는 호스트 컴퓨터에서 접근 가능한 로컬 디스크와 네트워크 스토리지 모두 가능
|                           |   |
| ------------------------- |   |
| |Bind mount: distributed| | <-|  
| ------------------------- |
|                           |
| -----------------------   |
| |     Volume mount    |   | <--- 볼륨 마운트는 도커가 관리하는 객체인 볼륨과 컨테이너의 대상 디렉토리를 연결함
| -----------------------   |
|                           |
| -----------------------   |
| |      Image Layer    |   | <--- 컨테이너의 초기 상태는 이미지 레이어에서 받은 상태로만 구성됨
| |  -----------------  |   |      도커파일 스크립트에서 이미지로 복사한 모든 파일이 해당됨
| |  |               |  |   |      읽기 전용이지만, 기록 중 복사(copy-on-write)를 사용해 컨테이너에서 수정할 수 있음
| |  -----------------  |   |
| |                     |   |
| |  -----------------  |   |
| |  |               |  |   |
| |  -----------------  |   |
| -----------------------   |
-----------------------------
```

#### 스토리지별 사용 예시

쓰기 가능 레이어
- 단기 저장
- 비용이 비싼 계산이나 네트워크를 통해 저장해야 하는 데이터 캐싱 등

로컬 바인드 마운트
- 호스트 컴퓨터-컨테이너 간 데이터 공유
- 소스 코드/설정 값을 개발자의 로컬 컴퓨터에서 컨테이너로 이미지 빌드 없이 즉시 전달할 수 없음

분산 바인드 마운트
- 네트워크 스토리지 - 컨테이너 간 데이터 공유
- 가용성이 높지만, 로컬 디스크와 비교해 지원하지 않는 파일 시스템 기능이 있거나 성능 면에서 차이가 있음
- 읽기 전용으로 설정 파일을 전달하거나 공유 캐시로 활용 가능
- 또는 읽기 쓰기 가능으로 설정하여 데이터를 저장해 동일 네트워크 상의 모든 컨테이너나 컴퓨터와 데이터를 공유하는 데 적합함

볼륨 마운트
- 컨테이너 - 도커 볼륨 간 데이터 공유
- 영구적으로 데이터 유지 가능

이미지 레이어
- 초기 파일 시스템 구성
- 읽기 전용, 여러 컨테이너가 공유함
- 레이너는 적층 구조를 갖는데, 후속 레이어와 이전 레이어의 내용이 충돌하는 경우 후속 레이어의 내용이 적용됨